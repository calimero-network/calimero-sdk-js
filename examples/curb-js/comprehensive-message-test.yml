description: Comprehensive Message Operations Test Workflow
name: Comprehensive Message Test

auth_service: true

nodes:
  chain_id: testnet-1
  count: 2
  image: ghcr.io/calimero-network/merod:edge
  prefix: curb-node

steps:
  # Step 1: Install the Curb application
  - name: Install Curb Application
    type: install_application
    node: curb-node-1
    path: './build/curb.wasm'
    dev: true
    outputs:
      app_id: applicationId

  # Step 2: Create a context for the Curb app
  - name: Create Curb Context
    type: create_context
    node: curb-node-1
    application_id: '{{app_id}}'
    params: '{"ownerUsername": "testuser", "defaultChannels": [{"name": "general"}]}'
    outputs:
      context_id: contextId
      member_public_key: memberPublicKey

  # Step 3: Wait for context creation and sync
  - name: Wait For Context Sync
    type: wait
    seconds: 1

  # Step 4: Create identity on node 2
  - name: Create Identity on Node 2
    type: create_identity
    node: curb-node-2
    outputs:
      public_key: publicKey

  # Step 5: Wait for Identity Setup
  - name: Wait for Identity Setup
    type: wait
    seconds: 8

  # Step 6: Invite Node 2 from Node 1
  - name: Invite Node 2 from Node 1
    type: invite_identity
    node: curb-node-1
    context_id: '{{context_id}}'
    grantee_id: '{{public_key}}'
    granter_id: '{{member_public_key}}'
    capability: member
    outputs:
      invitation: invitation

  # Step 7: Join Context from Node 2
  - name: Join Context from Node 2
    type: join_context
    node: curb-node-2
    context_id: '{{context_id}}'
    invitee_id: '{{public_key}}'
    invitation: '{{invitation}}'

  # Step 8: Wait for Context Sync
  - name: Wait for Context Sync After Join
    type: wait
    seconds: 6

  # Step 9: Join Chat from Node 2
  - name: Join Chat from Node 2
    type: call
    node: curb-node-2
    context_id: '{{context_id}}'
    executor_public_key: '{{public_key}}'
    method: joinChat
    args:
      input:
        username: Alice
    timeout: 60
    outputs:
      join_chat_node2: result.output

  # Step 10: Wait for Join Completion
  - name: Wait for Join Completion
    type: wait
    seconds: 6

  # ============================================
  # MESSAGE OPERATIONS TESTING
  # ============================================

  # Step 11: Send basic message from Node 1
  - name: Send Basic Message from Node 1
    type: call
    node: curb-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: sendMessage
    args:
      input:
        channelId: general
        text: "Hello! This is a basic message from node 1"
        messageId: test-msg-1
    outputs:
      basic_msg_n1: result.output

  # Step 12: Send message with emoji from Node 1
  - name: Send Message with Emoji from Node 1
    type: call
    node: curb-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: sendMessage
    args:
      input:
        channelId: general
        text: "This message has an emoji ‚úÖ and another one üéâ"
        messageId: test-msg-emoji-1
    outputs:
      emoji_msg_n1: result.output

  # Step 13: Send basic message from Node 2
  - name: Send Basic Message from Node 2
    type: call
    node: curb-node-2
    context_id: '{{context_id}}'
    executor_public_key: '{{public_key}}'
    method: sendMessage
    args:
      input:
        channelId: general
        text: "Hello from node 2!"
        messageId: test-msg-2
    outputs:
      basic_msg_n2: result.output

  # Step 14: Send message with emoji from Node 2
  - name: Send Message with Emoji from Node 2
    type: call
    node: curb-node-2
    context_id: '{{context_id}}'
    executor_public_key: '{{public_key}}'
    method: sendMessage
    args:
      input:
        channelId: general
        text: "Node 2 says hello with emojis! üöÄ ‚≠ê üíØ"
        messageId: test-msg-emoji-2
    outputs:
      emoji_msg_n2: result.output

  # Step 15: Wait for messages to sync
  - name: Wait for Messages Sync
    type: wait
    seconds: 5

  # Step 16: Fetch all messages from Node 1 (verify sync)
  - name: Fetch All Messages from Node 1
    type: call
    node: curb-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: getMessages
    args:
      input:
        channelId: general
    outputs:
      all_messages_n1: result.output

  # Step 17: Fetch all messages from Node 2 (verify sync)
  - name: Fetch All Messages from Node 2
    type: call
    node: curb-node-2
    context_id: '{{context_id}}'
    executor_public_key: '{{public_key}}'
    method: getMessages
    args:
      input:
        channelId: general
    outputs:
      all_messages_n2: result.output

  # Step 17b: Wait for messages to fully sync on both nodes
  - name: Wait for Full Message Sync
    type: wait
    seconds: 5

  # ============================================
  # REACTION OPERATIONS TESTING
  # ============================================

  # Step 18: Add reaction from Node 1 to Node 1's message
  - name: Add Reaction from Node 1 to Own Message
    type: call
    node: curb-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: updateReaction
    args:
      input:
        messageId: test-msg-1
        emoji: "üëç"
        add: true
        username: testuser
    outputs:
      reaction_n1_own: result.output

  # Step 19: Add reaction from Node 2 to Node 1's message
  - name: Add Reaction from Node 2 to Node 1 Message
    type: call
    node: curb-node-2
    context_id: '{{context_id}}'
    executor_public_key: '{{public_key}}'
    method: updateReaction
    args:
      input:
        messageId: test-msg-1
        emoji: "‚ù§Ô∏è"
        add: true
        username: Alice
    outputs:
      reaction_n2_to_n1: result.output

  # Step 20: Add reaction from Node 1 to Node 2's message
  - name: Add Reaction from Node 1 to Node 2 Message
    type: call
    node: curb-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: updateReaction
    args:
      input:
        messageId: test-msg-2
        emoji: "‚úÖ"
        add: true
        username: testuser
    outputs:
      reaction_n1_to_n2: result.output

  # Step 21: Add multiple reactions to emoji message
  - name: Add Multiple Reactions to Emoji Message
    type: call
    node: curb-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: updateReaction
    args:
      input:
        messageId: test-msg-emoji-1
        emoji: "üî•"
        add: true
        username: testuser
    outputs:
      reaction_fire: result.output

  - name: Add Second Reaction to Emoji Message
    type: call
    node: curb-node-2
    context_id: '{{context_id}}'
    executor_public_key: '{{public_key}}'
    method: updateReaction
    args:
      input:
        messageId: test-msg-emoji-1
        emoji: "üéâ"
        add: true
        username: Alice
    outputs:
      reaction_party: result.output

  # Step 22: Wait for reactions to sync
  - name: Wait for Reactions Sync
    type: wait
    seconds: 3

  # Step 23: Fetch messages with reactions from Node 1
  - name: Fetch Messages with Reactions from Node 1
    type: call
    node: curb-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: getMessages
    args:
      input:
        channelId: general
    outputs:
      messages_with_reactions_n1: result.output

  # Step 24: Fetch messages with reactions from Node 2
  - name: Fetch Messages with Reactions from Node 2
    type: call
    node: curb-node-2
    context_id: '{{context_id}}'
    executor_public_key: '{{public_key}}'
    method: getMessages
    args:
      input:
        channelId: general
    outputs:
      messages_with_reactions_n2: result.output

  # ============================================
  # EDIT MESSAGE OPERATIONS TESTING
  # ============================================

  # Step 25: Edit message from Node 1
  - name: Edit Message from Node 1
    type: call
    node: curb-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: editMessage
    args:
      input:
        channelId: general
        messageId: test-msg-1
        text: "Hello! This is an edited message from node 1 ‚úèÔ∏è"
    outputs:
      edit_result_n1: result.output

  # Step 26: Wait for edit to sync
  - name: Wait for Edit Sync
    type: wait
    seconds: 2

  # Step 27: Fetch messages after edit from both nodes
  - name: Fetch Messages After Edit from Node 1
    type: call
    node: curb-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: getMessages
    args:
      input:
        channelId: general
    outputs:
      messages_after_edit_n1: result.output

  - name: Fetch Messages After Edit from Node 2
    type: call
    node: curb-node-2
    context_id: '{{context_id}}'
    executor_public_key: '{{public_key}}'
    method: getMessages
    args:
      input:
        channelId: general
    outputs:
      messages_after_edit_n2: result.output

  # ============================================
  # THREAD OPERATIONS TESTING
  # ============================================

  # Step 28: Send thread reply (reply to a message)
  - name: Send Thread Reply from Node 1
    type: call
    node: curb-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: sendMessage
    args:
      input:
        channelId: general
        parentId: test-msg-1
        text: "This is a thread reply to the first message"
        messageId: test-thread-1
    outputs:
      thread_reply_n1: result.output

  # Step 29: Send another thread reply from Node 2
  - name: Send Thread Reply from Node 2
    type: call
    node: curb-node-2
    context_id: '{{context_id}}'
    executor_public_key: '{{public_key}}'
    method: sendMessage
    args:
      input:
        channelId: general
        parentId: test-msg-1
        text: "Another thread reply from node 2 üßµ"
        messageId: test-thread-2
    outputs:
      thread_reply_n2: result.output

  # Step 30: Send thread reply with emoji
  - name: Send Thread Reply with Emoji
    type: call
    node: curb-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: sendMessage
    args:
      input:
        channelId: general
        parentId: test-msg-emoji-1
        text: "Thread reply with emoji ‚úÖ"
        messageId: test-thread-emoji-1
    outputs:
      thread_emoji_reply: result.output

  # Step 31: Wait for thread messages to sync
  - name: Wait for Thread Messages Sync
    type: wait
    seconds: 3

  # Step 32: Fetch thread messages from Node 1
  - name: Fetch Thread Messages from Node 1
    type: call
    node: curb-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: getMessages
    args:
      input:
        channelId: general
        parentId: test-msg-1
    outputs:
      thread_messages_n1: result.output

  # Step 33: Fetch thread messages from Node 2
  - name: Fetch Thread Messages from Node 2
    type: call
    node: curb-node-2
    context_id: '{{context_id}}'
    executor_public_key: '{{public_key}}'
    method: getMessages
    args:
      input:
        channelId: general
        parentId: test-msg-1
    outputs:
      thread_messages_n2: result.output

  # ============================================
  # DELETE MESSAGE OPERATIONS TESTING
  # ============================================

  # Step 34: Delete a message from Node 1
  - name: Delete Message from Node 1
    type: call
    node: curb-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: deleteMessage
    args:
      input:
        channelId: general
        messageId: test-msg-2
    outputs:
      delete_result_n1: result.output

  # Step 35: Wait for delete to sync
  - name: Wait for Delete Sync
    type: wait
    seconds: 2

  # Step 36: Fetch messages after delete from both nodes
  - name: Fetch Messages After Delete from Node 1
    type: call
    node: curb-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: getMessages
    args:
      input:
        channelId: general
    outputs:
      messages_after_delete_n1: result.output

  - name: Fetch Messages After Delete from Node 2
    type: call
    node: curb-node-2
    context_id: '{{context_id}}'
    executor_public_key: '{{public_key}}'
    method: getMessages
    args:
      input:
        channelId: general
    outputs:
      messages_after_delete_n2: result.output

  # ============================================
  # PAGINATION TESTING
  # ============================================

  # Step 37: Test pagination - fetch first 2 messages
  - name: Fetch First 2 Messages (Pagination)
    type: call
    node: curb-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: getMessages
    args:
      input:
        channelId: general
        limit: 2
        offset: 0
    outputs:
      paginated_first_2: result.output

  # Step 38: Test pagination - fetch next 2 messages
  - name: Fetch Next 2 Messages (Pagination)
    type: call
    node: curb-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: getMessages
    args:
      input:
        channelId: general
        limit: 2
        offset: 2
    outputs:
      paginated_next_2: result.output

  # Step 39: Final fetch of all messages from both nodes
  - name: Final Fetch All Messages from Node 1
    type: call
    node: curb-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: getMessages
    args:
      input:
        channelId: general
    outputs:
      final_messages_n1: result.output

  - name: Final Fetch All Messages from Node 2
    type: call
    node: curb-node-2
    context_id: '{{context_id}}'
    executor_public_key: '{{public_key}}'
    method: getMessages
    args:
      input:
        channelId: general
    outputs:
      final_messages_n2: result.output

stop_all_nodes: false
restart: true
wait_timeout: 60

