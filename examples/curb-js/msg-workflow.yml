description: Curb Messaging Workflow
name: Curb Messaging Test

nodes:
  chain_id: testnet-1
  count: 1
  image: ghcr.io/calimero-network/merod:edge
  prefix: curb-node

steps:
  - name: Install Curb Application
    type: install_application
    node: curb-node-1
    path: './build/curb.wasm'
    dev: true
    outputs:
      app_id: applicationId

  - name: Create Curb Context
    type: create_context
    node: curb-node-1
    application_id: '{{app_id}}'
    params: '{"ownerUsername": "testuser", "defaultChannels": [{"name": "general"}], "isDMchat": false}'
    outputs:
      context_id: contextId
      member_public_key: memberPublicKey

  - name: Wait for Context
    type: wait
    seconds: 1

  - name: Send Message To General
    type: call
    node: curb-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: sendMessage
    args:
      channelId: general
      text: 'Hello General'
    outputs:
      general_message: result.output
      general_message_id: result.output.result

  - name: Fetch General Messages
    type: call
    node: curb-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: getMessages
    args:
      channelId: general
      limit: 10
    outputs:
      general_messages: result.output

  # - name: Create Events Channel
  #   type: call
  #   node: curb-node-1
  #   context_id: '{{context_id}}'
  #   executor_public_key: '{{member_public_key}}'
  #   method: createChannel
  #   args:
  #     channelId: events
  #     options:
  #       type: public
  #       readOnly: false
  #   outputs:
  #     events_channel: result.output

  # - name: Send Message To Events
  #   type: call
  #   node: curb-node-1
  #   context_id: '{{context_id}}'
  #   executor_public_key: '{{member_public_key}}'
  #   method: sendMessage
  #   args:
  #     channelId: events
  #     text: 'Hello Events'
  #   outputs:
  #     events_message: result.output
  #     events_message_id: result.output.result.id

  # - name: Fetch Events Messages
  #   type: call
  #   node: curb-node-1
  #   context_id: '{{context_id}}'
  #   executor_public_key: '{{member_public_key}}'
  #   method: getMessages
  #   args:
  #     channelId: events
  #     limit: 10
  #   outputs:
  #     events_messages: result.output

  # - name: Send Thread Reply
  #   type: call
  #   node: curb-node-1
  #   context_id: '{{context_id}}'
  #   executor_public_key: '{{member_public_key}}'
  #   method: sendMessage
  #   args:
  #     channelId: events
  #     parentId: '{{events_message_id}}'
  #     text: 'Thread reply'
  #   outputs:
  #     events_thread_message: result.output

  # - name: Fetch Events Thread Messages
  #   type: call
  #   node: curb-node-1
  #   context_id: '{{context_id}}'
  #   executor_public_key: '{{member_public_key}}'
  #   method: getMessages
  #   args:
  #     channelId: events
  #     parentId: '{{events_message_id}}'
  #     limit: 10
  #   outputs:
  #     events_thread_messages: result.output

stop_all_nodes: false
restart: true
wait_timeout: 60

