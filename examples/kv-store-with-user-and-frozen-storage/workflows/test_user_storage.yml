description: KV-Store user storage workflow test (JavaScript SDK)
name: KV-store user storage workflow

# Configuration options
stop_all_nodes: false
restart: false
wait_timeout: 120

nodes:
  chain_id: testnet-1
  count: 2
  image: ghcr.io/calimero-network/merod:edge
  prefix: user-storage-node

steps:
  # Step 1: Install the application on the first node
  - name: Install Application on Node 1
    type: install_application
    node: user-storage-node-1
    path: 'examples/kv-store-with-user-and-frozen-storage/build/service.wasm'
    dev: true
    outputs:
      app_id: applicationId

  # Step 2: Create mesh with both nodes
  - name: Create Mesh
    type: create_mesh
    context_node: user-storage-node-1
    application_id: '{{app_id}}'
    nodes:
      - user-storage-node-2
    capability: member
    outputs:
      context_id: contextId
      member_public_key: memberPublicKey

  # ============================================
  # Testing Phase: User Storage Simple
  # ============================================

  # Step 3: Simple user storage set
  - name: Simple user storage set test
    type: call
    node: user-storage-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: set_user_simple
    args:
      value: 'SomeSimpleUserString'

  # Step 4: Simple user storage get
  - name: Simple user storage get test
    type: call
    node: user-storage-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: get_user_simple
    outputs:
      simple_value_res: result

  - name: Assert simple user storage value got is expected
    type: json_assert
    statements:
      - 'json_equal({{simple_value_res}}, {"output": "SomeSimpleUserString"})'
  # ============================================
  # Testing Phase: User Storage Nested (using direct UnorderedMap)
  # ============================================

  # Step 5: Nested user storage set
  - name: Nested user storage set test
    type: call
    node: user-storage-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: set_user_nested
    args:
      key: 'UserNestedKey1'
      value: 'UserNestedValue1'

  # Wait for state to persist and nested tracking to propagate
  - name: Wait after nested set (for state persistence)
    type: wait
    duration: 2

  # Step 6: Nested user storage get
  - name: Nested user storage get test
    type: call
    node: user-storage-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: get_user_nested
    args:
      key: 'UserNestedKey1'
    outputs:
      nested_value_res: result

  - name: Assert nested user storage value got is expected
    type: json_assert
    statements:
      - 'json_equal({{nested_value_res}}, {"output": "UserNestedValue1"})'

  # ============================================
  # Cross-Node Sync Testing
  # ============================================

  # Wait for sync after Node 1 messages
  - name: Wait after Node 1 Messages
    type: wait_for_sync
    context_id: '{{context_id}}'
    nodes:
      - user-storage-node-1
      - user-storage-node-2
    timeout: 60
    check_interval: 2
    trigger_sync: true

  # Step 7: Node 2 gets simple user storage for a specific user (Node 1)
  - name: Node 2 - Simple user storage get test for a specific user
    type: call
    node: user-storage-node-2
    context_id: '{{context_id}}'
    executor_public_key: '{{public_key_user-storage-node-2}}'
    method: get_user_simple_for
    args:
      user_key: '{{member_public_key}}'
    outputs:
      node2_simple_value_res_specific_user: result

  - name: Assert simple user storage value got is expected (from Node 2)
    type: json_assert
    statements:
      - 'json_equal({{node2_simple_value_res_specific_user}}, {"output": "SomeSimpleUserString"})'

  # Step 8: Node 2 sets its own simple user storage
  - name: Node 2 - Simple user storage set
    type: call
    node: user-storage-node-2
    context_id: '{{context_id}}'
    executor_public_key: '{{public_key_user-storage-node-2}}'
    method: set_user_simple
    args:
      value: 'SimpleUserStringFromNode2'

  # Step 9: Node 2 gets its own simple user storage
  - name: Node 2 - Simple user storage get
    type: call
    node: user-storage-node-2
    context_id: '{{context_id}}'
    executor_public_key: '{{public_key_user-storage-node-2}}'
    method: get_user_simple
    outputs:
      node2_simple_value_res: result

  - name: Assert simple user storage on Node 2 value got is expected
    type: json_assert
    statements:
      - 'json_equal({{node2_simple_value_res}}, {"output": "SimpleUserStringFromNode2"})'

  # Wait for sync after Node 2 messages
  - name: Wait after Node 2 Messages
    type: wait_for_sync
    context_id: '{{context_id}}'
    nodes:
      - user-storage-node-1
      - user-storage-node-2
    timeout: 60
    check_interval: 2
    trigger_sync: true

  # Step 10: Node 1 gets Node 2's simple user storage
  - name: Node 1 - Simple user storage get for Node 2 user
    type: call
    node: user-storage-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: get_user_simple_for
    args:
      user_key: '{{public_key_user-storage-node-2}}'
    outputs:
      node1_simple_value_res_from_node2: result

  - name: Assert simple user storage value from Node 2 is expected
    type: json_assert
    statements:
      - 'json_equal({{node1_simple_value_res_from_node2}}, {"output": "SimpleUserStringFromNode2"})'
