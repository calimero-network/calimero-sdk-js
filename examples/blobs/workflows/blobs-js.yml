name: Blobs JS Example
description: Upload, announce, discover and delete blobs using the JavaScript SDK example.

force_pull_image: false
no_docker: true
binary_path: /Users/chefsale/workspace/calimero/core/target/release/merod

nodes:
  chain_id: calimero-testnet
  count: 2
  image: ghcr.io/calimero-network/merod:32adff7
  prefix: js-blob

steps:
  - name: Install JS blobs app on inviter
    type: install_application
    node: js-blob-1
    path: "examples/blobs/build/contract.wasm"
    dev: true
    outputs:
      app_id: applicationId

  - name: Create context from inviter
    type: create_context
    node: js-blob-1
    application_id: "{{app_id}}"
    outputs:
      context_id: contextId
      inviter_key: memberPublicKey

  - name: Assert context created
    type: assert
    statements:
      - "is_set({{context_id}})"
      - "is_set({{inviter_key}})"

  - name: Create invitee identity
    type: create_identity
    node: js-blob-2
    outputs:
      invitee_key: publicKey

  - name: Invite second node
    type: invite_identity
    node: js-blob-1
    context_id: "{{context_id}}"
    grantee_id: "{{invitee_key}}"
    granter_id: "{{inviter_key}}"
    capability: member
    outputs:
      invitation: invitation

  - name: Join context from invitee
    type: join_context
    node: js-blob-2
    context_id: "{{context_id}}"
    invitee_id: "{{invitee_key}}"
    invitation: "{{invitation}}"

  - name: Wait for context sync
    type: wait
    seconds: 3

  - name: Upload sample PNG blob
    type: upload_blob
    node: js-blob-1
    file_path: examples/blobs/static/sample.png
    context_id: "{{context_id}}"
    outputs:
      png_blob_id: blob_id
      png_blob_size: size

  - name: Register PNG metadata
    type: call
    node: js-blob-1
    context_id: "{{context_id}}"
    executor_public_key: "{{inviter_key}}"
    method: uploadFile
    args:
      name: screenshot.png
      blobId: "{{png_blob_id}}"
      size: "{{png_blob_size}}"
      mimeType: image/png
    outputs:
      png_file_id: result.output.fileId

  - name: Assert PNG registered
    type: assert
    statements:
      - "is_set({{png_file_id}})"

  - name: Upload sample TXT blob
    type: upload_blob
    node: js-blob-1
    file_path: examples/blobs/static/test.txt
    context_id: "{{context_id}}"
    outputs:
      txt_blob_id: blob_id
      txt_blob_size: size

  - name: Register TXT metadata
    type: call
    node: js-blob-1
    context_id: "{{context_id}}"
    executor_public_key: "{{inviter_key}}"
    method: uploadFile
    args:
      name: readme.txt
      blobId: "{{txt_blob_id}}"
      size: "{{txt_blob_size}}"
      mimeType: text/plain
    outputs:
      txt_file_id: result.output.fileId

  - name: Assert TXT registered
    type: assert
    statements:
      - "is_set({{txt_file_id}})"

  - name: Wait for announcements
    type: wait
    seconds: 6

  - name: Check file count on inviter
    type: call
    node: js-blob-1
    context_id: "{{context_id}}"
    executor_public_key: "{{inviter_key}}"
    method: getFileCount
    outputs:
      inviter_count: result

  - name: Assert inviter sees two files
    type: json_assert
    statements:
      - "json_equal({{inviter_count}}, {\"output\": 2})"

  - name: Check file count on invitee
    type: call
    node: js-blob-2
    context_id: "{{context_id}}"
    executor_public_key: "{{invitee_key}}"
    method: getFileCount
    outputs:
      invitee_count: result

  - name: Assert invitee sees two files
    type: json_assert
    statements:
      - "json_equal({{invitee_count}}, {\"output\": 2})"

  - name: Get PNG file blob id
    type: call
    node: js-blob-1
    context_id: "{{context_id}}"
    executor_public_key: "{{inviter_key}}"
    method: getBlobId
    args:
      fileId: "{{png_file_id}}"
    outputs:
      retrieved_png_blob: result.output.blobId

  - name: Assert PNG blob id matches
    type: assert
    statements:
      - "equal({{retrieved_png_blob}}, {{png_blob_id}})"

  - name: Delete PNG file
    type: call
    node: js-blob-1
    context_id: "{{context_id}}"
    executor_public_key: "{{inviter_key}}"
    method: deleteFile
    args:
      fileId: "{{png_file_id}}"

  - name: Wait for delete propagation
    type: wait
    seconds: 6

  - name: Check file count after delete
    type: call
    node: js-blob-2
    context_id: "{{context_id}}"
    executor_public_key: "{{invitee_key}}"
    method: getFileCount
    outputs:
      final_count: result

  - name: Assert only one file remains
    type: json_assert
    statements:
      - "json_equal({{final_count}}, {\"output\": 1})"

stop_all_nodes: false
restart: false
wait_timeout: 120

