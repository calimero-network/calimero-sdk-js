# Builder C Code

This directory contains the C glue code that bridges QuickJS and Calimero host functions.

## Files

- `builder.c` - Main C code that:
  - Initializes QuickJS runtime
  - Registers Calimero host functions
  - Exports service methods as WASM functions
  
- `code.h` - Generated by QuickJS compiler (qjsc)
  - Contains compiled JavaScript bytecode
  - Auto-generated during build
  
- `methods.h` - Generated by method extractor
  - Contains WASM method exports
  - Auto-generated during build

## Build Process

1. TypeScript → JavaScript (Rollup)
2. JavaScript → `code.h` (QuickJS qjsc)
3. Extract methods → `methods.h` (Babel parser)
4. Compile all → WASM (Clang/WASI-SDK)
5. Embed `storage_wasm.wasm` via `storage_wasm.h`

### Updating `storage_wasm.h`

The header is generated from the Rust `storage-wasm` crate. Regenerate it whenever storage logic
changes so the bundled QuickJS runtime stays in sync:

```bash
cargo build --release --target wasm32-wasip1 -p storage-wasm
cp target/wasm32-wasip1/release/storage_wasm.wasm calimero-sdk-js/packages/sdk/src/wasm/storage_wasm.wasm
xxd -i calimero-sdk-js/packages/sdk/src/wasm/storage_wasm.wasm > calimero-sdk-js/packages/cli/builder/storage_wasm.h
```

The Calimero node images consume the same header at build time, so make sure the binary and header
are refreshed before producing new SDK releases or container images.

## Host Functions

All Calimero host functions are wrapped and exposed as `env.*` in JavaScript:

```javascript
// Available in JavaScript services:
env.log_utf8(msg)
env.storage_read(key, register_id)
env.storage_write(key, value, register_id)
env.context_id(register_id)
env.executor_id(register_id)
env.emit(kind, data)
env.commit(root, artifact)
// ... and more
```

## Do Not Edit

- `code.h` and `methods.h` are auto-generated
- Only `builder.c` should be modified if needed

