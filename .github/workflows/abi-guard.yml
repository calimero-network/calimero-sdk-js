name: ABI Guard

permissions:
  contents: read

on:
  pull_request:
    branches:
      - master
  push:
    branches:
      - master

env:
  NODE_VERSION: "18.x"
  PNPM_VERSION: "9"

jobs:
  abi-validation:
    name: ABI Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
        
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
          
      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          
      - name: Build packages
        run: pnpm build
          
      - name: Run ABI conformance tests
        run: |
          cd tests/integration && pnpm test abi-conformance.test.ts
          
      - name: Install abi-conformance dependencies (skip postinstall)
        run: |
          cd examples/abi-conformance
          # Skip postinstall scripts to avoid QuickJS download (not needed for ABI verification)
          pnpm install --ignore-scripts || pnpm install --frozen-lockfile --ignore-scripts
        continue-on-error: true
          
      - name: Run ABI verification script
        run: |
          chmod +x scripts/verify-abi.sh
          ./scripts/verify-abi.sh
          
      - name: Verify ABI generation on examples
        run: |
          set -e
          echo "Building examples with ABI generation enabled..."
          
          # Build counter example
          cd examples/counter
          pnpm build:manual || pnpm build
          if [ -f build/abi.json ]; then
            echo "✓ Counter example: ABI generated successfully"
            cat build/abi.json | jq '.schema_version, .state_root, .methods | length, .events | length' || true
          else
            echo "⚠ Counter example: No ABI file found (may be expected if ABI generation is optional)"
          fi
          
          # Build kv-store example
          cd ../kv-store
          pnpm build:manual || pnpm build
          if [ -f build/abi.json ]; then
            echo "✓ KV-Store example: ABI generated successfully"
            cat build/abi.json | jq '.schema_version, .state_root, .methods | length' || true
          else
            echo "⚠ KV-Store example: No ABI file found"
          fi
          
          # Build blobs example
          cd ../blobs
          pnpm build:manual || pnpm build
          if [ -f build/abi.json ]; then
            echo "✓ Blobs example: ABI generated successfully"
            cat build/abi.json | jq '.schema_version, .state_root, .methods | length, .events | length' || true
          else
            echo "⚠ Blobs example: No ABI file found"
          fi
          
      - name: Validate ABI manifest structure
        run: |
          set -e
          echo "Validating ABI manifest structure..."
          
          # Check if any ABI files were generated
          ABI_FILES=$(find examples -name "abi.json" -type f || true)
          
          if [ -z "$ABI_FILES" ]; then
            echo "⚠ No ABI files found in examples (this may be expected if ABI generation is not yet integrated)"
            exit 0
          fi
          
          # Validate each ABI file
          for abi_file in $ABI_FILES; do
            echo "Validating: $abi_file"
            
            # Check if jq is available
            if command -v jq &> /dev/null; then
              # Validate schema_version
              SCHEMA_VERSION=$(jq -r '.schema_version' "$abi_file" || echo "")
              if [ "$SCHEMA_VERSION" != "wasm-abi/1" ]; then
                echo "❌ Invalid schema_version in $abi_file: $SCHEMA_VERSION"
                exit 1
              fi
              
              # Validate required fields exist
              jq -e '.types' "$abi_file" > /dev/null || { echo "❌ Missing 'types' field in $abi_file"; exit 1; }
              jq -e '.methods' "$abi_file" > /dev/null || { echo "❌ Missing 'methods' field in $abi_file"; exit 1; }
              jq -e '.events' "$abi_file" > /dev/null || { echo "❌ Missing 'events' field in $abi_file"; exit 1; }
              
              # Validate types is an object
              TYPES_TYPE=$(jq -r '.types | type' "$abi_file")
              if [ "$TYPES_TYPE" != "object" ]; then
                echo "❌ 'types' must be an object in $abi_file, got: $TYPES_TYPE"
                exit 1
              fi
              
              # Validate methods is an array
              METHODS_TYPE=$(jq -r '.methods | type' "$abi_file")
              if [ "$METHODS_TYPE" != "array" ]; then
                echo "❌ 'methods' must be an array in $abi_file, got: $METHODS_TYPE"
                exit 1
              fi
              
              # Validate events is an array
              EVENTS_TYPE=$(jq -r '.events | type' "$abi_file")
              if [ "$EVENTS_TYPE" != "array" ]; then
                echo "❌ 'events' must be an array in $abi_file, got: $EVENTS_TYPE"
                exit 1
              fi
              
              echo "✓ $abi_file is valid"
            else
              echo "⚠ jq not available, skipping detailed validation"
              # Basic JSON validation
              node -e "JSON.parse(require('fs').readFileSync('$abi_file', 'utf8'))" || { echo "❌ Invalid JSON in $abi_file"; exit 1; }
              echo "✓ $abi_file is valid JSON"
            fi
          done
          
          echo "✓ All ABI files validated successfully"
          
      - name: Run unit tests for ABI modules
        run: |
          # Run any unit tests related to ABI generation
          pnpm test:unit 2>/dev/null || echo "No unit tests found for ABI modules"
          
      - name: Check ABI type compatibility
        run: |
          set -e
          echo "Checking ABI type definitions compatibility..."
          
          # Verify that CLI and SDK ABI types are compatible
          if [ -f "packages/cli/src/abi/emitter.ts" ] && [ -f "packages/sdk/src/abi/types.ts" ]; then
            echo "✓ Both CLI and SDK ABI type definitions exist"
            
            # Check if types are exported correctly
            if grep -q "export.*AbiManifest" packages/cli/src/abi/emitter.ts && \
               grep -q "export.*AbiManifest" packages/sdk/src/abi/types.ts; then
              echo "✓ AbiManifest type is exported from both packages"
            else
              echo "⚠ AbiManifest type may not be exported correctly"
            fi
          else
            echo "⚠ ABI type definition files not found (may be expected in early PRs)"
          fi

