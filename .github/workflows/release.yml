name: Release and Publish

on:
    push:
        branches:
            - master
            - main
        paths:
            - "package.json"
            - "packages/sdk/package.json"
            - "packages/cli/package.json"
    workflow_dispatch: 

jobs:
    detect-version-change:
        name: Detect Version Change
        runs-on: ubuntu-latest
        outputs:
            version-changed: ${{ steps.check.outputs.changed }}
            version: ${{ steps.check.outputs.version }}
            tag: ${{ steps.check.outputs.tag }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 2 

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 18.x

            - name: Check if version changed
              id: check
              run: |
                  # Get current versions
                  CURRENT_SDK=$(node -p "require('./packages/sdk/package.json').version")
                  CURRENT_CLI=$(node -p "require('./packages/cli/package.json').version")

                  # Get previous versions (if they exist)
                  git checkout HEAD~1 packages/sdk/package.json packages/cli/package.json 2>/dev/null || true
                  PREV_SDK=$(node -p "require('./packages/sdk/package.json').version" 2>/dev/null || echo "")
                  PREV_CLI=$(node -p "require('./packages/cli/package.json').version" 2>/dev/null || echo "")

                  # Restore current versions
                  git checkout HEAD packages/sdk/package.json packages/cli/package.json

                  echo "Previous SDK version: ${PREV_SDK:-none}"
                  echo "Current SDK version: $CURRENT_SDK"
                  echo "Previous CLI version: ${PREV_CLI:-none}"
                  echo "Current CLI version: $CURRENT_CLI"

                  # Check if versions match between packages
                  if [ "$CURRENT_SDK" != "$CURRENT_CLI" ]; then
                    echo "Error: Package versions must match. SDK: $CURRENT_SDK, CLI: $CURRENT_CLI"
                    exit 1
                  fi

                  # Check if version changed
                  if [ -z "$PREV_SDK" ] || [ "$CURRENT_SDK" != "$PREV_SDK" ]; then
                    echo "changed=true" >> $GITHUB_OUTPUT
                    echo "version=$CURRENT_SDK" >> $GITHUB_OUTPUT
                    echo "tag=v$CURRENT_SDK" >> $GITHUB_OUTPUT
                    echo "✓ Version changed to $CURRENT_SDK"
                  else
                    echo "changed=false" >> $GITHUB_OUTPUT
                    echo "version=" >> $GITHUB_OUTPUT
                    echo "tag=" >> $GITHUB_OUTPUT
                    echo "No version change detected"
                  fi

    release:
        name: Create Release and Publish
        runs-on: ubuntu-latest
        needs: detect-version-change
        if: needs.detect-version-change.outputs.version-changed == 'true' || github.event_name == 'workflow_dispatch'
        permissions:
            contents: write # Required to create releases and tags
            id-token: write # Required for GitHub token

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup pnpm
              uses: pnpm/action-setup@v2
              with:
                  version: 9

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 18.x
                  cache: "pnpm"
                  registry-url: "https://registry.npmjs.org"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Get version
              id: version
              run: |
                  if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
                    # For manual trigger, read from package.json
                    VERSION=$(node -p "require('./packages/sdk/package.json').version")
                  else
                    # Use version from previous job
                    VERSION="${{ needs.detect-version-change.outputs.version }}"
                  fi

                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "tag=v$VERSION" >> $GITHUB_OUTPUT
                  echo "✓ Using version: $VERSION"

            - name: Check if tag already exists
              id: check-tag
              run: |
                  TAG="${{ steps.version.outputs.tag }}"
                  if git rev-parse "$TAG" >/dev/null 2>&1; then
                    echo "exists=true" >> $GITHUB_OUTPUT
                    echo "Tag $TAG already exists - skipping tag creation"
                  else
                    echo "exists=false" >> $GITHUB_OUTPUT
                    echo "Tag $TAG does not exist - will create"
                  fi

            - name: Create git tag
              if: steps.check-tag.outputs.exists == 'false'
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git tag -a "${{ steps.version.outputs.tag }}" -m "Release ${{ steps.version.outputs.tag }}"
                  git push origin "${{ steps.version.outputs.tag }}"

            - name: Build packages
              run: pnpm build

            - name: Extract release notes from CHANGELOG
              id: changelog
              run: |
                  VERSION="${{ steps.version.outputs.version }}"
                  TAG="${{ steps.version.outputs.tag }}"

                  if [ -f CHANGELOG.md ]; then
                    # Extract content between version header and next version header
                    awk -v version="$VERSION" '
                      /^## \[/{ 
                        if (found) exit
                        if ($0 ~ "\\[" version "\\]") {
                          found=1
                          next
                        }
                      }
                      found { 
                        if (/^## \[/) exit
                        print
                      }
                    ' CHANGELOG.md > release_notes.txt || true
                    
                    if [ -s release_notes.txt ]; then
                      echo "## Release $TAG" > full_release_notes.txt
                      echo "" >> full_release_notes.txt
                      cat release_notes.txt >> full_release_notes.txt
                    else
                      echo "## Release $TAG" > full_release_notes.txt
                      echo "" >> full_release_notes.txt
                      echo "See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/$TAG/CHANGELOG.md) for details." >> full_release_notes.txt
                    fi
                  else
                    echo "## Release $TAG" > full_release_notes.txt
                    echo "" >> full_release_notes.txt
                    echo "Automated release of Calimero SDK JS packages." >> full_release_notes.txt
                  fi

                  {
                    echo "notes<<EOF"
                    cat full_release_notes.txt
                    echo "EOF"
                  } >> $GITHUB_OUTPUT

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: ${{ steps.version.outputs.tag }}
                  name: Release ${{ steps.version.outputs.tag }}
                  body: ${{ steps.changelog.outputs.notes }}
                  draft: false
                  prerelease: ${{ contains(steps.version.outputs.version, '-') }}
                  generate_release_notes: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Publish @calimero/sdk to npm
              run: cd packages/sdk && pnpm publish --access public --no-git-checks
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

            - name: Publish @calimero/cli to npm
              run: cd packages/cli && pnpm publish --access public --no-git-checks
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
