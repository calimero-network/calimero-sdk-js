description: Comprehensive Nested Collections Test (JavaScript SDK)
name: Comprehensive Nested Collections Test

force_pull_image: true

nodes:
  chain_id: testnet-1
  count: 2
  image: ghcr.io/calimero-network/merod:edge
  prefix: nested-node

steps:
  - name: Install Nested Collections Demo Application
    type: install_application
    node: nested-node-1
    path: "examples/nested-collections-demo/build/service.wasm"
    dev: true
    outputs:
      app_id: applicationId

  - name: Create Nested Collections Context
    type: create_context
    node: nested-node-1
    application_id: '{{app_id}}'
    params: '{}'
    outputs:
      context_id: contextId
      member_public_key: memberPublicKey

  - name: Wait for Context Creation
    type: wait
    seconds: 1

  - name: Create Node 2 Identity
    type: create_identity
    node: nested-node-2
    outputs:
      node_2_member_public_key: publicKey

  - name: Wait After Identity Creation
    type: wait
    seconds: 1

  - name: Invite Node 2 To Context
    type: invite_identity
    node: nested-node-1
    context_id: '{{context_id}}'
    grantee_id: '{{node_2_member_public_key}}'
    granter_id: '{{member_public_key}}'
    capability: member
    outputs:
      node_2_invitation: invitation

  - name: Node 2 Join Context
    type: join_context
    node: nested-node-2
    context_id: '{{context_id}}'
    invitee_id: '{{node_2_member_public_key}}'
    invitation: '{{node_2_invitation}}'

  - name: Wait After Node 2 Join
    type: wait
    seconds: 2

  # Test nested Map<string, Map<string, Set<string>>> structure
  - name: Add First Reaction (üëç from alice to message1)
    type: call
    node: nested-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: addToMapMapSet
    args:
      outerKey: message1
      innerKey: "üëç"
      value: alice

  - name: Wait After First Reaction
    type: wait
    seconds: 1

  - name: Add Second Reaction (üëç from bob to message1)
    type: call
    node: nested-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: addToMapMapSet
    args:
      outerKey: message1
      innerKey: "üëç"
      value: bob

  - name: Add Third Reaction (‚ù§Ô∏è from alice to message1)
    type: call
    node: nested-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: addToMapMapSet
    args:
      outerKey: message1
      innerKey: "‚ù§Ô∏è"
      value: alice

  - name: Wait After Reactions
    type: wait
    seconds: 1

  # Test nested Map<string, Set<string>> structure
  - name: Add User to Admin Group
    type: call
    node: nested-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: addToMapSet
    args:
      key: admins
      value: alice

  - name: Add User to Moderator Group
    type: call
    node: nested-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: addToMapSet
    args:
      key: moderators
      value: bob

  - name: Add Another User to Admin Group
    type: call
    node: nested-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: addToMapSet
    args:
      key: admins
      value: charlie

  - name: Wait For Changes to Propagate
    type: wait
    seconds: 2

  # Verify reactions on Node 1
  - name: Get Reactions for message1 on Node 1
    type: call
    node: nested-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: getMapMapSet
    args:
      outerKey: message1
    outputs:
      reactions_node_1: result.output

  # Verify groups on Node 1
  - name: Get Admin Group Members on Node 1
    type: call
    node: nested-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: getMapSet
    args:
      key: admins
    outputs:
      admin_group_node_1: result.output

  - name: Get All Groups on Node 1
    type: call
    node: nested-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: getAllMapSet
    args: {}
    outputs:
      all_groups_node_1: result.output

  # Wait for replication to Node 2
  - name: Wait For Replication to Node 2
    type: wait
    seconds: 3

  # Verify reactions on Node 2 (testing automatic propagation)
  - name: Get Reactions for message1 on Node 2
    type: call
    node: nested-node-2
    context_id: '{{context_id}}'
    executor_public_key: '{{node_2_member_public_key}}'
    method: getMapMapSet
    args:
      outerKey: message1
    outputs:
      reactions_node_2: result.output

  # Verify groups on Node 2 (testing automatic propagation)
  - name: Get Admin Group Members on Node 2
    type: call
    node: nested-node-2
    context_id: '{{context_id}}'
    executor_public_key: '{{node_2_member_public_key}}'
    method: getMapSet
    args:
      key: admins
    outputs:
      admin_group_node_2: result.output

  - name: Get All Groups on Node 2
    type: call
    node: nested-node-2
    context_id: '{{context_id}}'
    executor_public_key: '{{node_2_member_public_key}}'
    method: getAllMapSet
    args: {}
    outputs:
      all_groups_node_2: result.output

  # Test nested collection modification from Node 2
  - name: Add Reaction from Node 2 (üöÄ from dave to message1)
    type: call
    node: nested-node-2
    context_id: '{{context_id}}'
    executor_public_key: '{{node_2_member_public_key}}'
    method: addToMapMapSet
    args:
      outerKey: message1
      innerKey: "üöÄ"
      value: dave

  - name: Remove Reaction from Node 2 (üëç from alice)
    type: call
    node: nested-node-2
    context_id: '{{context_id}}'
    executor_public_key: '{{node_2_member_public_key}}'
    method: removeFromMapMapSet
    args:
      outerKey: message1
      innerKey: "üëç"
      value: alice

  - name: Wait For Cross-Node Changes
    type: wait
    seconds: 2

  # Verify final state on both nodes
  - name: Get Final Reactions on Node 1
    type: call
    node: nested-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: getMapMapSet
    args:
      outerKey: message1
    outputs:
      final_reactions_node_1: result.output

  - name: Get Final Reactions on Node 2
    type: call
    node: nested-node-2
    context_id: '{{context_id}}'
    executor_public_key: '{{node_2_member_public_key}}'
    method: getMapMapSet
    args:
      outerKey: message1
    outputs:
      final_reactions_node_2: result.output

  # Assert that nested collections are properly synchronized
  - name: Assert Reactions Consistency
    type: json_assert
    statements:
      # Both nodes should have the same final state (using json_equal for complex objects)
      - 'json_equal({{final_reactions_node_1}}, {{final_reactions_node_2}})'
      # Admin groups should be equal across nodes (using json_equal for arrays)
      - 'json_equal({{admin_group_node_1}}, {{admin_group_node_2}})'
      # All groups should be consistent across nodes (using json_equal for complex objects)
      - 'json_equal({{all_groups_node_1}}, {{all_groups_node_2}})'

stop_all_nodes: false
restart: true
wait_timeout: 120
