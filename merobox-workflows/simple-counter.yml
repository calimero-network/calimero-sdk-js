description: Simple Counter Application Test Workflow
name: Counter App Test

force_pull_image: false
no_docker: true
binary_path: /Users/chefsale/workspace/calimero/core/target/release/merod

nodes:
  chain_id: testnet-1
  count: 2
  image: ghcr.io/calimero-network/merod:edge
  prefix: counter-node

steps:
  # Step 1: Install the counter application
  - name: Install Counter Application
    type: install_application
    node: counter-node-1
    path: "./examples/counter/build/contract.wasm"
    dev: true
    outputs:
      app_id: applicationId

  # Step 2: Create a context for the counter app
  - name: Create Counter Context
    type: create_context
    node: counter-node-1
    application_id: '{{app_id}}'
    params: '{}'
    outputs:
      context_id: contextId
      member_public_key: memberPublicKey

  # Step 3: Wait for context creation and sync
  - name: Wait for Context Creation
    type: wait
    seconds: 1

  - name: Create Node 2 Identity
    type: create_identity
    node: counter-node-2
    outputs:
      node_2_member_public_key: publicKey

  - name: Invite Node 2 To Context
    type: invite_identity
    node: counter-node-1
    context_id: '{{context_id}}'
    grantee_id: '{{node_2_member_public_key}}'
    granter_id: '{{member_public_key}}'
    capability: member
    outputs:
      node_2_invitation: invitation

  - name: Node 2 Join Context
    type: join_context
    node: counter-node-2
    context_id: '{{context_id}}'
    invitee_id: '{{node_2_member_public_key}}'
    invitation: '{{node_2_invitation}}'

  - name: Wait After Node 2 Join
    type: wait
    seconds: 1

  # Step 4: Get initial count (should be 0)
  - name: Get Initial Count
    type: call
    node: counter-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: getCount
    args: {}
    outputs:
      initial_count_node_1: result.output

  # Step 5: Increment counter
  - name: Increment Counter (First Time)
    type: call
    node: counter-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: increment
    args: {}

  # Step 6: Wait for increment to complete
  - name: Wait After First Increment
    type: wait
    seconds: 1

  # Step 7: Get count after first increment (should be 1)
  - name: Get Count After First Increment
    type: call
    node: counter-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: getCount
    args: {}
    outputs:
      post_increment_count_node_1: result.output

  - name: Assert Counter State On Node 1
    type: json_assert
    statements:
      - 'equal({{initial_count_node_1}}, 0)'
      - 'equal({{post_increment_count_node_1}}, 1)'

  # Step 8: Test string return with hello method
  - name: Call Hello Method
    type: call
    node: counter-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: hello
    args: {}
    outputs:
      hello_response_node_1: result.output

  - name: Assert Hello Response
    type: json_assert
    statements:
      - 'json_equal({{hello_response_node_1}}, {"message":"hello world from QuickJS!"})'

  # Step 9: Allow state replication to the second node
  - name: Wait For Replication
    type: wait
    seconds: 2

  # Step 10: Verify count on the second node
  - name: Get Count On Node 2
    type: call
    node: counter-node-2
    context_id: '{{context_id}}'
    executor_public_key: '{{node_2_member_public_key}}'
    method: getCount
    args: {}
    outputs:
      post_increment_count_node_2: result.output

  - name: Assert Replicated Counter Value
    type: json_assert
    statements:
      - 'equal({{post_increment_count_node_2}}, 1)'
      - 'equal({{post_increment_count_node_1}}, {{post_increment_count_node_2}})'

# Configuration options
stop_all_nodes: true
restart: false
wait_timeout: 60
