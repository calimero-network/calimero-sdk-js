description: Private Data Application Workflow (JavaScript SDK)
name: Private Data App Test

force_pull_image: true

nodes:
  chain_id: testnet-1
  count: 2
  image: ghcr.io/calimero-network/merod:edge
  prefix: private-data-node

steps:
  - name: Install Private Data Application
    type: install_application
    node: private-data-node-1
    path: "examples/private-data/build/service.wasm"
    dev: true
    outputs:
      app_id: applicationId

  - name: Create Private Data Context
    type: create_context
    node: private-data-node-1
    application_id: '{{app_id}}'
    params: '{}'
    outputs:
      context_id: contextId
      member_public_key: memberPublicKey

  - name: Wait for Context Creation
    type: wait
    seconds: 1

  - name: Create Node 2 Identity
    type: create_identity
    node: private-data-node-2
    outputs:
      node_2_member_public_key: publicKey

  - name: Wait After Identity Creation
    type: wait
    seconds: 1

  - name: Invite Node 2 To Context
    type: invite_identity
    node: private-data-node-1
    context_id: '{{context_id}}'
    grantee_id: '{{node_2_member_public_key}}'
    granter_id: '{{member_public_key}}'
    capability: member
    outputs:
      node_2_invitation: invitation

  - name: Node 2 Join Context
    type: join_context
    node: private-data-node-2
    context_id: '{{context_id}}'
    invitee_id: '{{node_2_member_public_key}}'
    invitation: '{{node_2_invitation}}'

  - name: Wait After Node 2 Join
    type: wait
    seconds: 4

  - name: Node 1 Set Public Note
    type: call
    node: private-data-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: setPublicNote
    args:
      title: welcome
      content: hello-world

  - name: Node 1 Set Private Note
    type: call
    node: private-data-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: setPrivateNote
    args:
      note: node1-secret

  - name: Wait After Node 1 Updates
    type: wait
    seconds: 6

  - name: Node 1 Reads Public Note
    type: call
    node: private-data-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: getPublicNote
    args:
      title: welcome
    outputs:
      public_note_node_1: result.output.value

  - name: Assert Node 1 Public Note Stored
    type: json_assert
    statements:
      - 'equal({{public_note_node_1}}, "hello-world")'

  - name: Wait Before Node 2 Read
    type: wait
    seconds: 4

  - name: Node 2 Reads Public Note
    type: call
    node: private-data-node-2
    context_id: '{{context_id}}'
    executor_public_key: '{{node_2_member_public_key}}'
    method: getPublicNote
    args:
      title: welcome
    outputs:
      public_note_node_2: result.output.value

  - name: Assert Public Note Replicated
    type: json_assert
    statements:
      - 'equal({{public_note_node_2}}, "hello-world")'

  - name: Node 2 Reads Private Note
    type: call
    node: private-data-node-2
    context_id: '{{context_id}}'
    executor_public_key: '{{node_2_member_public_key}}'
    method: getPrivateNote
    outputs:
      private_note_node_2: result

  - name: Assert Node 2 Has No Private Note Initially
    type: json_assert
    statements:
      - 'json_equal({{private_note_node_2}}, {"output": null})'

  - name: Node 2 Sets Private Note
    type: call
    node: private-data-node-2
    context_id: '{{context_id}}'
    executor_public_key: '{{node_2_member_public_key}}'
    method: setPrivateNote
    args:
      note: node2-secret

  - name: Wait After Node 2 Private Update
    type: wait
    seconds: 1

  - name: Node 1 Reads Own Private Note
    type: call
    node: private-data-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: getPrivateNote
    outputs:
      private_note_node_1: result.output
      private_note_node_1_note: result.output.note

  - name: Assert Node 1 Private Note Unchanged
    type: json_assert
    statements:
      - 'equal({{private_note_node_1_note}}, "node1-secret")'

  - name: Node 1 Clears Private Note
    type: call
    node: private-data-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: clearPrivateNote

  - name: Wait After Node 1 Clear
    type: wait
    seconds: 1

  - name: Node 1 Confirms Private Note Cleared
    type: call
    node: private-data-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: getPrivateNote
    outputs:
      private_note_node_1_cleared: result

  - name: Assert Private Note Cleared
    type: json_assert
    statements:
      - 'json_equal({{private_note_node_1_cleared}}, {"output": null})'

stop_all_nodes: false
restart: true
wait_timeout: 120